<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Washington Sports Hub</title>
<style>
  :root{ --bg:#0b1220; --panel:#0f1b33; --card:#101f3d; --soft:#162a52; --text:#e9eefc; --muted:#a9b7dd; --border:rgba(255,255,255,.10); --shadow:0 12px 30px rgba(0,0,0,.25); --r:16px; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Arial,sans-serif; background:radial-gradient(1200px 700px at 20% -10%, rgba(121,166,255,.20), transparent 55%), var(--bg); color:var(--text); }
  header{ position:sticky; top:0; z-index:10; background:rgba(11,18,32,.85); backdrop-filter: blur(10px); border-bottom:1px solid var(--border); }
  .top{ max-width:1100px; margin:0 auto; padding:16px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .brand h1{ margin:0; font-size:20px; }
  .brand .sub{ margin-top:4px; color:var(--muted); font-size:13px; }
  .pill{ border:1px solid var(--border); border-radius:999px; padding:8px 10px; color:var(--muted); font-size:13px; }

  .wrap{ max-width:1100px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 320px 1fr; gap:14px; }
  @media(max-width:900px){ .wrap{ grid-template-columns:1fr; } }

  .panel{ background:rgba(15,27,51,.85); border:1px solid var(--border); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; }
  .phead{ padding:12px 14px; border-bottom:1px solid var(--border); color:var(--muted); text-transform:uppercase; letter-spacing:.2px; font-size:12px; }
  .list{ padding:10px; display:flex; flex-direction:column; gap:10px; }
  .btn{ width:100%; text-align:left; border:1px solid var(--border); background:rgba(0,0,0,.12); color:var(--text); padding:12px 12px; border-radius:14px; cursor:pointer; }
  .btn:hover{ background:rgba(121,166,255,.12); }
  .btn.active{ background:rgba(121,166,255,.18); border-color:rgba(121,166,255,.35); }
  .btn .t{ font-weight:800; }
  .btn .m{ color:var(--muted); font-size:12px; margin-top:4px; }

  .content{ padding:14px; }
  .hero{ display:flex; align-items:center; gap:12px; padding:14px; border:1px solid var(--border); border-radius:var(--r); background:rgba(0,0,0,.12); }
  .logo{ width:56px; height:56px; border-radius:14px; border:1px solid var(--border); background:rgba(0,0,0,.2); display:flex; align-items:center; justify-content:center; overflow:hidden; flex:0 0 auto;}
  .logo img{ width:100%; height:100%; object-fit:contain; padding:8px; }
  .hname{ font-size:20px; font-weight:900; margin:0; }
  .hsub{ color:var(--muted); font-size:13px; margin-top:4px; }

  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
  @media(max-width:900px){ .grid{ grid-template-columns:1fr; } }
  .card{ border:1px solid var(--border); background:rgba(0,0,0,.12); border-radius:var(--r); padding:14px; }
  .card h3{ margin:0 0 10px 0; color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.2px; }
  .row{ padding:10px 0; border-bottom:1px solid rgba(255,255,255,.06); display:flex; justify-content:space-between; gap:10px; }
  .row:last-child{ border-bottom:none; }
  .a{ font-weight:800; }
  .b{ color:var(--muted); font-size:12px; margin-top:4px; }
  .right{ text-align:right; color:var(--muted); font-size:12px; white-space:nowrap; }
  .score{ color:var(--text); font-weight:900; font-size:13px; }
  .small{ color:var(--muted); font-size:12px; line-height:1.4; }

  .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
  .tab{ border:1px solid var(--border); background:rgba(0,0,0,.12); color:var(--text); padding:10px 12px; border-radius:999px; cursor:pointer; font-size:13px; }
  .tab.active{ background:rgba(121,166,255,.18); border-color:rgba(121,166,255,.35); }
</style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand">
      <h1>Washington Sports Hub</h1>
      <div class="sub">Iteration 2 ‚Ä¢ ESPN-powered ‚Ä¢ Live scores + latest/next game + roster + news</div>
    </div>
    <div class="pill" id="pill">‚óè Ready</div>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="phead">DC Area Teams</div>
    <div class="list" id="menu"></div>
    <div style="padding:12px 14px; border-top:1px solid var(--border);" class="small">
      If you ever see ‚Äúwrong team‚Äù again, it means the upstream source is wrong ‚Äî this build is designed to prevent that by using team-specific ESPN endpoints (via a Worker to avoid CORS).  [oai_citation:2‚Ä°Gist](https://gist.github.com/akeaswaran/b48b02f1c94f873c6655e7129910fc3b?permalink_comment_id=4704846&utm_source=chatgpt.com)
    </div>
  </div>

  <div class="panel">
    <div class="content">
      <div class="hero">
        <div class="logo" id="logo">üèõÔ∏è</div>
        <div>
          <div class="hname" id="teamName">Select a team</div>
          <div class="hsub" id="teamMeta">Live ‚Ä¢ Latest ‚Ä¢ Next ‚Ä¢ Roster ‚Ä¢ News</div>
        </div>
      </div>

      <div class="tabs" id="tabs" style="display:none;">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="live">Live Now</button>
        <button class="tab" data-tab="schedule">Schedule (latest/next)</button>
        <button class="tab" data-tab="roster">Roster</button>
        <button class="tab" data-tab="news">News</button>
      </div>

      <div id="view" style="margin-top:12px;">
        <div class="card">
          <h3>Welcome</h3>
          <div class="small">Pick a team on the left.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // üî• SET THIS to your deployed Cloudflare Worker URL:
  const WORKER_BASE = "https://washington-sports-proxy.wright-j-andrew.workers.dev";

  const TEAMS = [
    { key:"commanders", league:"nfl", abbr:"wsh", name:"Washington Commanders" },
    { key:"wizards", league:"nba", abbr:"wsh", name:"Washington Wizards" },
    { key:"capitals", league:"nhl", abbr:"wsh", name:"Washington Capitals" },
    { key:"nationals", league:"mlb", abbr:"wsh", name:"Washington Nationals" },
    { key:"dcunited", league:"mls", abbr:"dc",  name:"D.C. United" }
  ];

  const el = id => document.getElementById(id);
  const menu = el("menu");
  const pill = el("pill");
  const logo = el("logo");
  const teamName = el("teamName");
  const teamMeta = el("teamMeta");
  const tabs = el("tabs");
  const view = el("view");

  let selected = null;
  let cache = null;

  function setPill(text, ok=true){
    pill.textContent = "‚óè " + text;
    pill.style.color = ok ? "var(--muted)" : "#ffb4b4";
    pill.style.borderColor = ok ? "var(--border)" : "rgba(255,180,180,.35)";
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtDate(iso){
    if(!iso) return "‚Äî";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    return d.toLocaleString(undefined, { weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
  }

  function renderMenu(){
    menu.innerHTML = "";
    TEAMS.forEach(t=>{
      const b = document.createElement("button");
      b.className = "btn" + (selected?.key===t.key ? " active": "");
      b.innerHTML = `<div class="t">${escapeHtml(t.name)}</div><div class="m">${escapeHtml(t.league.toUpperCase())}</div>`;
      b.onclick = ()=> selectTeam(t);
      menu.appendChild(b);
    });
  }

  function setActiveTab(tab){
    [...tabs.querySelectorAll(".tab")].forEach(x=>x.classList.toggle("active", x.dataset.tab===tab));
  }

  tabs.addEventListener("click", (e)=>{
    const b = e.target.closest(".tab");
    if(!b || !selected || !cache) return;
    setActiveTab(b.dataset.tab);
    renderTab(b.dataset.tab);
  });

  async function getTeamBundle(team){
    const url = `${WORKER_BASE}/team?league=${encodeURIComponent(team.league)}&abbr=${encodeURIComponent(team.abbr)}`;
    const res = await fetch(url, { cache:"no-store" });
    const data = await res.json();
    if(!res.ok || data.error) throw new Error(data.error || "Fetch failed");
    return data;
  }

  // --- ESPN schedule parsing helpers ---
  function extractScheduleEvents(scheduleJson){
    // ESPN schedule commonly has an "events" array. We defensively check a few shapes.
    return scheduleJson?.events
        || scheduleJson?.schedule?.[0]?.events
        || scheduleJson?.schedule?.events
        || [];
  }

  function normalizeEvent(e){
    const name = e?.name || e?.shortName || e?.matchup || e?.summary || "Game";
    const date = e?.date || e?.competitions?.[0]?.date || e?.startDate || null;

    const comp = e?.competitions?.[0];
    const status = comp?.status?.type?.description || e?.status?.type?.description || "‚Äî";
    const completed = !!(comp?.status?.type?.completed || e?.status?.type?.completed);

    const competitors = comp?.competitors || e?.competitors || [];
    let home = competitors.find(c=>c.homeAway==="home");
    let away = competitors.find(c=>c.homeAway==="away");

    // fallback: if not labeled, use order
    if(!home && competitors.length>=2){ home = competitors[0]; away = competitors[1]; }

    const hs = home?.score ?? comp?.competitors?.[0]?.score ?? null;
    const as = away?.score ?? comp?.competitors?.[1]?.score ?? null;

    const homeName = home?.team?.displayName || home?.team?.shortDisplayName || "";
    const awayName = away?.team?.displayName || away?.team?.shortDisplayName || "";

    return { name, date, status, completed, homeName, awayName, hs, as };
  }

  function getLatestAndNext(scheduleJson){
    const raw = extractScheduleEvents(scheduleJson).map(normalizeEvent).filter(x=>x.date);
    raw.sort((a,b)=> new Date(a.date) - new Date(b.date));

    const now = Date.now();
    const past = raw.filter(x=> x.completed || new Date(x.date).getTime() < now);
    const future = raw.filter(x=> !x.completed && new Date(x.date).getTime() >= now);

    const latest = past.length ? past[past.length-1] : null;
    const next = future.length ? future[0] : null;

    return { latest, next };
  }

  // --- Live scoreboard parsing ---
  function getLiveGames(scoreboardJson, teamId){
    const events = scoreboardJson?.events || [];
    const live = [];
    for (const e of events){
      const comp = e?.competitions?.[0];
      const competitors = comp?.competitors || [];
      const hasTeam = competitors.some(c => String(c?.team?.id) === String(teamId));
      if(!hasTeam) continue;

      const status = comp?.status?.type?.description || e?.status?.type?.description || "‚Äî";
      const inProgress = !!comp?.status?.type?.inProgress;

      // We show both in-progress and today‚Äôs final games, but prioritize in-progress
      const n = normalizeEvent(e);
      n.inProgress = inProgress;
      live.push(n);
    }
    live.sort((a,b)=> (b.inProgress===a.inProgress)? (new Date(b.date)-new Date(a.date)) : (b.inProgress - a.inProgress));
    return live.slice(0,5);
  }

  function renderRows(items, rightBuilder){
    if(!items.length){
      return `<div class="small">No data found.</div>`;
    }
    return items.map(it=>{
      const title = it.name || `${it.awayName} @ ${it.homeName}`;
      const sub = it.date ? `${fmtDate(it.date)} ‚Ä¢ ${it.status}` : it.status;
      const right = rightBuilder ? rightBuilder(it) : "";
      return `
        <div class="row">
          <div>
            <div class="a">${escapeHtml(title)}</div>
            <div class="b">${escapeHtml(sub)}</div>
          </div>
          <div class="right">${right}</div>
        </div>
      `;
    }).join("");
  }

  function renderOverview(){
    const { latest, next } = getLatestAndNext(cache.schedule);
    const liveGames = getLiveGames(cache.scoreboard, cache.meta.teamId);

    const liveCard = `
      <div class="card">
        <h3>Live Now / Today</h3>
        ${liveGames.length
          ? renderRows(liveGames, (g)=> `<div class="score">${escapeHtml(g.hs ?? "‚Äî")} : ${escapeHtml(g.as ?? "‚Äî")}</div>`)
          : `<div class="small">No live/today game found.</div>`}
      </div>
    `;

    const latestCard = `
      <div class="card">
        <h3>Most Recent Game</h3>
        ${latest
          ? renderRows([latest], (g)=> `<div class="score">${escapeHtml(g.hs ?? "‚Äî")} : ${escapeHtml(g.as ?? "‚Äî")}</div>`)
          : `<div class="small">No completed game found.</div>`}
      </div>
    `;

    const nextCard = `
      <div class="card">
        <h3>Next Game</h3>
        ${next
          ? renderRows([next], ()=> ``)
          : `<div class="small">No upcoming game found.</div>`}
      </div>
    `;

    view.innerHTML = `
      <div class="grid">
        ${liveCard}
        ${latestCard}
      </div>
      <div style="margin-top:12px;">
        ${nextCard}
      </div>
    `;
  }

  function renderRoster(){
    const athletes = cache.roster?.athletes || cache.roster?.team?.athletes || [];
    const flat = [];

    // ESPN roster sometimes groups by position categories
    if (Array.isArray(athletes)) {
      // could be groups with items
      for (const group of athletes){
        if (group?.items && Array.isArray(group.items)){
          for (const p of group.items) flat.push(p);
        }
      }
    }

    const players = flat.length ? flat : (cache.roster?.athletes || []);
    if (!players || !players.length){
      view.innerHTML = `<div class="card"><h3>Roster</h3><div class="small">Roster unavailable.</div></div>`;
      return;
    }

    const rows = players.slice(0,60).map(p=>{
      const n = p?.fullName || p?.displayName || "‚Äî";
      const pos = p?.position?.abbreviation || p?.position?.name || "‚Äî";
      const jersey = p?.jersey ? `#${p.jersey}` : "";
      return `
        <div class="row">
          <div>
            <div class="a">${escapeHtml(n)} <span class="b">${escapeHtml(jersey)}</span></div>
            <div class="b">${escapeHtml(pos)}</div>
          </div>
          <div class="right">${escapeHtml(p?.experience?.years != null ? (p.experience.years + " yrs") : "")}</div>
        </div>
      `;
    }).join("");

    view.innerHTML = `<div class="card"><h3>Roster</h3>${rows}</div>`;
  }

  function renderNews(){
    const articles = cache.news?.articles || cache.news?.headlines || [];
    if(!articles.length){
      view.innerHTML = `<div class="card"><h3>News</h3><div class="small">No news found.</div></div>`;
      return;
    }
    const rows = articles.slice(0,10).map(a=>{
      const title = a?.headline || a?.title || "‚Äî";
      const link = a?.links?.web?.href || a?.links?.api?.href || a?.link || "";
      const when = a?.published || a?.lastModified || "";
      return `
        <div class="row">
          <div>
            <div class="a">${escapeHtml(title)}</div>
            <div class="b">${when ? escapeHtml(fmtDate(when)) : ""}</div>
          </div>
          <div class="right">${link ? `<a href="${escapeHtml(link)}" target="_blank" rel="noopener">Open</a>` : ""}</div>
        </div>
      `;
    }).join("");

    view.innerHTML = `<div class="card"><h3>Top News</h3>${rows}</div>`;
  }

  function renderSchedule(){
    const { latest, next } = getLatestAndNext(cache.schedule);
    view.innerHTML = `
      <div class="card">
        <h3>Latest Completed</h3>
        ${latest ? renderRows([latest], g=> `<div class="score">${escapeHtml(g.hs ?? "‚Äî")} : ${escapeHtml(g.as ?? "‚Äî")}</div>`)
                : `<div class="small">No completed game found.</div>`}
      </div>
      <div style="margin-top:12px;" class="card">
        <h3>Next Upcoming</h3>
        ${next ? renderRows([next])
              : `<div class="small">No upcoming game found.</div>`}
      </div>
    `;
  }

  function renderLive(){
    const liveGames = getLiveGames(cache.scoreboard, cache.meta.teamId);
    view.innerHTML = `
      <div class="card">
        <h3>Live Now / Today</h3>
        ${liveGames.length
          ? renderRows(liveGames, (g)=> `<div class="score">${escapeHtml(g.hs ?? "‚Äî")} : ${escapeHtml(g.as ?? "‚Äî")}</div>`)
          : `<div class="small">No live/today game found.</div>`}
      </div>
    `;
  }

  function renderTab(tab){
    if(tab==="overview") return renderOverview();
    if(tab==="live") return renderLive();
    if(tab==="schedule") return renderSchedule();
    if(tab==="roster") return renderRoster();
    if(tab==="news") return renderNews();
  }

  async function selectTeam(team){
    selected = team;
    cache = null;
    renderMenu();
    tabs.style.display = "flex";
    setActiveTab("overview");

    // Reset hero
    teamName.textContent = team.name;
    teamMeta.textContent = `${team.league.toUpperCase()} ‚Ä¢ Loading‚Ä¶`;
    logo.textContent = "‚è≥";
    setPill("Loading‚Ä¶", true);
    view.innerHTML = `<div class="card"><h3>Loading</h3><div class="small">Fetching ESPN data‚Ä¶</div></div>`;

    try {
      const data = await getTeamBundle(team);
      cache = data;

      // hero
      const logoUrl = data.meta.logo;
      if (logoUrl) logo.innerHTML = `<img src="${escapeHtml(logoUrl)}" alt="logo">`;
      else logo.textContent = "üèõÔ∏è";

      teamName.textContent = data.meta.teamName || team.name;
      teamMeta.textContent = `${team.league.toUpperCase()} ‚Ä¢ Team ID ${data.meta.teamId}`;
      setPill("Loaded", true);

      renderOverview();
    } catch (e) {
      setPill("Error", false);
      teamMeta.textContent = `Load failed: ${e}`;
      view.innerHTML = `<div class="card"><h3>Error</h3><div class="small">${escapeHtml(String(e))}</div></div>`;
    }
  }

  renderMenu();
</script>
</body>
</html>
