<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Washington Sports Hub</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0c2340">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DC Sports">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
  :root{
    --bg:#0b1220;
    --panel:#0f1b33;
    --card:#101f3d;
    --soft:#162a52;
    --text:#e9eefc;
    --muted:#a9b7dd;
    --accent:#79a6ff;
    --good:#7dffb2;
    --bad:#ff9aa2;
    --border:rgba(255,255,255,.10);
    --shadow:0 14px 34px rgba(0,0,0,.28);
    --r:18px;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Inter,Arial,sans-serif;
    background:
      radial-gradient(1100px 700px at 12% -12%, rgba(121,166,255,.24), transparent 55%),
      radial-gradient(900px 600px at 95% -10%, rgba(125,255,178,.10), transparent 55%),
      var(--bg);
    color:var(--text);
  }
  a{ color:var(--accent); text-decoration:none; }
  a:hover{ text-decoration:underline; }
  header{
    position:sticky; top:0; z-index:20;
    background:rgba(11,18,32,.86);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--border);
  }
  .top{
    max-width:1180px; margin:0 auto;
    padding:14px 14px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand{ display:flex; flex-direction:column; gap:4px; }
  .brand h1{ margin:0; font-size:18px; letter-spacing:.2px; }
  .brand .sub{ color:var(--muted); font-size:12.5px; }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    border:1px solid var(--border); border-radius:999px;
    padding:8px 10px; font-size:12.5px; color:var(--muted);
  }
  .dot{ width:8px; height:8px; border-radius:999px; background:var(--muted); }
  .wrap{
    max-width:1180px; margin:0 auto;
    padding:14px;
    display:grid;
    grid-template-columns: 340px 1fr;
    gap:14px;
  }
  @media(max-width:980px){ .wrap{ grid-template-columns:1fr; } }

  .panel{
    background:rgba(15,27,51,.86);
    border:1px solid var(--border);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .phead{
    padding:12px 14px;
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .phead .title{
    color:var(--muted);
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.2px;
  }
  .search{
    width:100%;
    margin:10px 14px 0;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--border);
    background:rgba(0,0,0,.16);
    color:var(--text);
    outline:none;
    font-size:14px;
  }
  .teamList{ padding:12px 14px 14px; display:flex; flex-direction:column; gap:10px; }
  .teamBtn{
    width:100%;
    border:1px solid var(--border);
    background:rgba(0,0,0,.12);
    color:var(--text);
    padding:12px 12px;
    border-radius:16px;
    cursor:pointer;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    transition: transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .teamBtn:hover{ transform: translateY(-1px); background: rgba(121,166,255,.08); border-color: rgba(121,166,255,.28); }
  .teamBtn.active{ background: rgba(121,166,255,.14); border-color: rgba(121,166,255,.38); }
  .teamLeft{ display:flex; flex-direction:column; gap:4px; text-align:left; min-width:0; }
  .teamName{ font-weight:800; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .teamMeta{ color:var(--muted); font-size:12px; display:flex; gap:8px; flex-wrap:wrap; }
  .tag{
    display:inline-flex; align-items:center;
    padding:5px 9px;
    border-radius:999px;
    border:1px solid var(--border);
    background:rgba(0,0,0,.10);
    color:var(--muted);
    font-size:11.5px;
  }

  .content{ padding:14px; }
  .hero{
    display:flex; align-items:center; gap:12px;
    padding:14px;
    border:1px solid var(--border);
    border-radius:var(--r);
    background:rgba(0,0,0,.12);
  }
  .logo{
    width:58px; height:58px;
    border-radius:16px;
    border:1px solid var(--border);
    background:rgba(0,0,0,.18);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
    flex:0 0 auto;
  }
  .logo img{ width:100%; height:100%; object-fit:contain; padding:8px; }
  .heroMain{ min-width:0; }
  .heroMain .name{ margin:0; font-size:20px; font-weight:900; letter-spacing:.2px; }
  .heroMain .meta{ color:var(--muted); font-size:13px; margin-top:4px; display:flex; gap:10px; flex-wrap:wrap; }
  .rightStats{ margin-left:auto; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
  .stat{
    min-width:140px;
    border:1px solid var(--border);
    background:rgba(0,0,0,.10);
    border-radius:16px;
    padding:10px 12px;
  }
  .stat .k{ color:var(--muted); font-size:12px; }
  .stat .v{ margin-top:5px; font-size:13.5px; font-weight:800; }

  .tabs{
    display:flex; gap:8px; flex-wrap:wrap;
    margin-top:12px;
  }
  .tab{
    border:1px solid var(--border);
    background:rgba(0,0,0,.12);
    color:var(--text);
    padding:10px 12px;
    border-radius:999px;
    cursor:pointer;
    font-size:13px;
  }
  .tab.active{
    border-color: rgba(121,166,255,.50);
    background: rgba(121,166,255,.16);
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    margin-top:12px;
  }
  @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }

  .card{
    border:1px solid var(--border);
    background:rgba(0,0,0,.12);
    border-radius:var(--r);
    padding:14px;
    overflow:hidden;
  }
  .card h3{
    margin:0 0 10px 0;
    font-size:12px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:.22px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .btnRow{ display:flex; gap:8px; flex-wrap:wrap; }
  .miniBtn{
    border:1px solid var(--border);
    background:rgba(0,0,0,.10);
    color:var(--text);
    border-radius:999px;
    padding:8px 10px;
    cursor:pointer;
    font-size:12.5px;
  }
  .miniBtn:hover{ background:rgba(121,166,255,.10); }

  .row{
    padding:10px 0;
    border-bottom:1px solid rgba(255,255,255,.06);
    display:flex; justify-content:space-between; gap:12px;
  }
  .row:last-child{ border-bottom:none; }
  .left{ min-width:0; }
  .a{ font-weight:850; }
  .b{ color:var(--muted); font-size:12px; margin-top:4px; }
  .right{ text-align:right; color:var(--muted); font-size:12px; white-space:nowrap; }
  .score{ color:var(--text); font-weight:900; font-size:13px; }
  .small{ color:var(--muted); font-size:12px; line-height:1.45; }
  .warn{ color:var(--bad); }
  .ok{ color:var(--good); }

  details{ margin-top:12px; }
  summary{ cursor:pointer; color:var(--muted); font-size:12px; }
  pre{
    white-space:pre-wrap; word-break:break-word;
    background:rgba(0,0,0,.18);
    border:1px solid var(--border);
    padding:12px;
    border-radius:16px;
    color:var(--text);
    font-size:12px;
    overflow:auto;
  }

  .footerNote{ padding:10px 14px 14px; color:var(--muted); font-size:12px; border-top:1px solid var(--border); }
</style>
</head>
<body>

<header>
  <div class="top">
    <div class="brand">
      <h1>Washington Sports Hub</h1>
      <div class="sub">PWA ‚Ä¢ Favorites ‚Ä¢ Live / latest / next ‚Ä¢ Standings ‚Ä¢ Roster ‚Ä¢ Injuries ‚Ä¢ News</div>
    </div>
    <div class="pill" id="pill"><span class="dot" id="dot"></span><span id="pillText">Ready</span></div>
  </div>
</header>

<div class="wrap">
  <!-- LEFT -->
  <div class="panel">
    <div class="phead">
      <div class="title">DC Area Teams</div>
      <button class="miniBtn" id="toggleFavsBtn" title="Show favorites only">‚òÖ</button>
    </div>

    <input class="search" id="teamSearch" placeholder="Search teams‚Ä¶" />

    <div class="teamList" id="teamList"></div>

    <div class="footerNote">
      Install: iPhone Safari ‚Üí Share ‚Üí Add to Home Screen.
    </div>
  </div>

  <!-- RIGHT -->
  <div class="panel">
    <div class="content">
      <div class="hero" id="hero">
        <div class="logo" id="logoBox">üèõÔ∏è</div>
        <div class="heroMain">
          <div class="name" id="heroName">Select a team</div>
          <div class="meta" id="heroMeta">Live ‚Ä¢ Latest ‚Ä¢ Next ‚Ä¢ Standings ‚Ä¢ Roster ‚Ä¢ Injuries ‚Ä¢ News</div>
        </div>
        <div class="rightStats">
          <div class="stat">
            <div class="k">Record</div>
            <div class="v" id="heroRecord">‚Äî</div>
          </div>
          <div class="stat">
            <div class="k">Venue</div>
            <div class="v" id="heroVenue">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="tabs" id="tabs" style="display:none;">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="live">Live</button>
        <button class="tab" data-tab="schedule">Schedule</button>
        <button class="tab" data-tab="standings">Standings</button>
        <button class="tab" data-tab="roster">Roster</button>
        <button class="tab" data-tab="injuries">Injuries</button>
        <button class="tab" data-tab="news">News</button>
        <button class="tab" data-tab="settings">Settings</button>
      </div>

      <div id="view">
        <div class="card">
          <h3>Welcome</h3>
          <div class="small">Pick a team on the left. Use ‚òÖ to favorite teams and show favorites-only.</div>
        </div>
      </div>

      <details id="debugWrap" style="display:none;">
        <summary>Debug (Worker response)</summary>
        <pre id="debugPre"></pre>
      </details>
    </div>
  </div>
</div>

<script>
  // Your Worker base (already set)
  const WORKER_BASE = "https://washington-sports-proxy.wright-j-andrew.workers.dev";

  // Teams + league/abbr mapping
  const TEAMS = [
    { key:"commanders", league:"nfl", abbr:"wsh", name:"Washington Commanders" },
    { key:"wizards",    league:"nba", abbr:"wsh", name:"Washington Wizards" },
    { key:"capitals",   league:"nhl", abbr:"wsh", name:"Washington Capitals" },
    { key:"nationals",  league:"mlb", abbr:"wsh", name:"Washington Nationals" },
    { key:"dcunited",   league:"mls", abbr:"dc",  name:"D.C. United" }
  ];

  const $ = (id)=>document.getElementById(id);
  const pillText = $("pillText");
  const dot = $("dot");
  const teamList = $("teamList");
  const teamSearch = $("teamSearch");
  const toggleFavsBtn = $("toggleFavsBtn");
  const tabs = $("tabs");
  const view = $("view");
  const debugWrap = $("debugWrap");
  const debugPre = $("debugPre");

  const heroName = $("heroName");
  const heroRecord = $("heroRecord");
  const heroVenue = $("heroVenue");
  const logoBox = $("logoBox");

  let selected = null;   // {key, league, abbr, name, ...meta}
  let bundle = null;     // worker response
  let showFavsOnly = false;

  // ----- State / prefs
  const LS_FAVS = "dcSports:favs:v1";
  const LS_LAST = "dcSports:lastTeam:v1";

  function loadFavs(){
    try { return new Set(JSON.parse(localStorage.getItem(LS_FAVS) || "[]")); }
    catch { return new Set(); }
  }
  function saveFavs(set){
    localStorage.setItem(LS_FAVS, JSON.stringify([...set]));
  }
  function setLastTeamKey(key){
    localStorage.setItem(LS_LAST, key);
  }
  function getLastTeamKey(){
    return localStorage.getItem(LS_LAST) || "";
  }

  let favs = loadFavs();

  // ----- UI helpers
  function setStatus(text, type="idle"){
    pillText.textContent = text;
    dot.style.background =
      type==="ok" ? "var(--good)" :
      type==="bad" ? "var(--bad)" :
      "var(--muted)";
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fmtDate(iso){
    if(!iso) return "‚Äî";
    const d = new Date(iso);
    if(isNaN(d.getTime())) return iso;
    return d.toLocaleString(undefined, { weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
  }

  function countdownTo(iso){
    if(!iso) return "";
    const t = new Date(iso).getTime();
    if(isNaN(t)) return "";
    const diff = t - Date.now();
    if(diff <= 0) return "now";
    const mins = Math.floor(diff/60000);
    const hrs = Math.floor(mins/60);
    const days = Math.floor(hrs/24);
    if(days>0) return `${days}d ${hrs%24}h`;
    if(hrs>0) return `${hrs}h ${mins%60}m`;
    return `${mins}m`;
  }

  function renderTeamMenu(){
    teamList.innerHTML = "";
    const q = teamSearch.value.trim().toLowerCase();

    const filtered = TEAMS.filter(t=>{
      if(showFavsOnly && !favs.has(t.key)) return false;
      if(!q) return true;
      return t.name.toLowerCase().includes(q) || t.league.toLowerCase().includes(q);
    });

    filtered.forEach(t=>{
      const btn = document.createElement("button");
      const isActive = selected?.key === t.key;
      btn.className = "teamBtn" + (isActive ? " active" : "");
      const isFav = favs.has(t.key);

      btn.innerHTML = `
        <div class="teamLeft">
          <div class="teamName">${escapeHtml(t.name)}</div>
          <div class="teamMeta">
            <span class="tag">${escapeHtml(t.league.toUpperCase())}</span>
            <span class="tag">${isFav ? "‚òÖ Favorite" : "‚òÜ Not favorite"}</span>
          </div>
        </div>
        <button class="miniBtn" data-fav="${escapeHtml(t.key)}" title="Toggle favorite">${isFav ? "‚òÖ" : "‚òÜ"}</button>
      `;

      btn.onclick = (e)=>{
        const favKey = e.target?.getAttribute?.("data-fav");
        if(favKey){
          toggleFavorite(favKey);
          e.stopPropagation();
          return;
        }
        selectTeam(t);
      };

      teamList.appendChild(btn);
    });

    if(!filtered.length){
      const empty = document.createElement("div");
      empty.className = "small";
      empty.style.padding = "6px 2px";
      empty.textContent = "No teams match that filter.";
      teamList.appendChild(empty);
    }
  }

  function toggleFavorite(key){
    if(favs.has(key)) favs.delete(key);
    else favs.add(key);
    saveFavs(favs);
    renderTeamMenu();
  }

  function setHero(meta){
    heroName.textContent = meta?.teamName || meta?.fallbackName || "Select a team";
    heroRecord.textContent = meta?.recordSummary || "‚Äî";
    heroVenue.textContent = meta?.venue || "‚Äî";
    if(meta?.logo){
      logoBox.innerHTML = `<img src="${escapeHtml(meta.logo)}" alt="logo">`;
    } else {
      logoBox.textContent = "üèõÔ∏è";
    }
  }

  function setActiveTab(tab){
    [...tabs.querySelectorAll(".tab")].forEach(b=>b.classList.toggle("active", b.dataset.tab === tab));
  }

  tabs.addEventListener("click", (e)=>{
    const btn = e.target.closest(".tab");
    if(!btn || !bundle) return;
    setActiveTab(btn.dataset.tab);
    renderTab(btn.dataset.tab);
  });

  teamSearch.addEventListener("input", renderTeamMenu);
  toggleFavsBtn.addEventListener("click", ()=>{
    showFavsOnly = !showFavsOnly;
    toggleFavsBtn.textContent = showFavsOnly ? "‚òÖ" : "‚òÜ";
    toggleFavsBtn.title = showFavsOnly ? "Showing favorites only" : "Show favorites only";
    renderTeamMenu();
  });

  // ----- Data loading
  async function fetchBundle(team){
    const url = `${WORKER_BASE}/team?league=${encodeURIComponent(team.league)}&abbr=${encodeURIComponent(team.abbr)}&t=${Date.now()}`;
    const res = await fetch(url, { cache:"no-store" });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { data = { error: "Non-JSON response from Worker", raw: text }; }

    // Always populate debug (so you can self-diagnose without back-and-forth)
    debugWrap.style.display = "block";
    debugPre.textContent = JSON.stringify(data, null, 2);

    if(!res.ok || data?.error) throw new Error(data?.error || ("HTTP " + res.status));
    if(!data?.meta) throw new Error("Worker response missing meta");
    return data;
  }

  // ESPN schedule parsing
  function extractScheduleEvents(scheduleJson){
    return scheduleJson?.events
      || scheduleJson?.schedule?.[0]?.events
      || scheduleJson?.schedule?.events
      || [];
  }

  function normalizeEvent(e){
    const comp = e?.competitions?.[0] || null;
    const statusObj = comp?.status?.type || e?.status?.type || {};
    const state = (statusObj?.state || statusObj?.name || "").toLowerCase();
    const statusDesc = statusObj?.description || e?.status?.type?.description || "‚Äî";

    const completed = !!statusObj?.completed || state === "post" || state === "final";
    const date = e?.date || comp?.date || e?.startDate || null;

    const competitors = comp?.competitors || e?.competitors || [];
    let home = competitors.find(c=>c.homeAway==="home");
    let away = competitors.find(c=>c.homeAway==="away");
    if(!home && competitors.length>=2){ home = competitors[0]; away = competitors[1]; }

    const homeName = home?.team?.displayName || home?.team?.shortDisplayName || "";
    const awayName = away?.team?.displayName || away?.team?.shortDisplayName || "";
    const hs = home?.score ?? null;
    const as = away?.score ?? null;

    const name = e?.name || e?.shortName || (awayName && homeName ? `${awayName} @ ${homeName}` : "Game");
    return { name, date, status: statusDesc, completed, hs, as, inProgress: !!statusObj?.inProgress };
  }

  function getLatestAndNext(scheduleJson){
    const raw = extractScheduleEvents(scheduleJson).map(normalizeEvent).filter(x=>x.date);
    raw.sort((a,b)=> new Date(a.date) - new Date(b.date));
    const now = Date.now();
    const past = raw.filter(x => x.completed || new Date(x.date).getTime() < now);
    const future = raw.filter(x => !x.completed && new Date(x.date).getTime() >= now);
    return { latest: past.length ? past[past.length-1] : null, next: future.length ? future[0] : null, all: raw };
  }

  function getLiveGames(scoreboardJson, teamId){
    const events = scoreboardJson?.events || [];
    const out = [];
    for(const e of events){
      const comp = e?.competitions?.[0];
      const competitors = comp?.competitors || [];
      const hasTeam = competitors.some(c => String(c?.team?.id) === String(teamId));
      if(!hasTeam) continue;
      out.push(normalizeEvent(e));
    }
    out.sort((a,b)=> (b.inProgress===a.inProgress) ? (new Date(b.date)-new Date(a.date)) : (b.inProgress - a.inProgress));
    return out.slice(0,10);
  }

  function renderRows(items, rightBuilder){
    if(!items || !items.length) return `<div class="small">No data found.</div>`;
    return items.map(it=>{
      const sub = it.date ? `${fmtDate(it.date)} ‚Ä¢ ${it.status}` : it.status;
      const right = rightBuilder ? rightBuilder(it) : "";
      return `
        <div class="row">
          <div class="left">
            <div class="a">${escapeHtml(it.name)}</div>
            <div class="b">${escapeHtml(sub)}</div>
          </div>
          <div class="right">${right}</div>
        </div>
      `;
    }).join("");
  }

  function renderOverview(){
    const meta = bundle?.meta || {};
    const { latest, next } = getLatestAndNext(bundle?.schedule || {});
    const live = getLiveGames(bundle?.scoreboard || {}, meta.teamId);

    view.innerHTML = `
      <div class="grid">
        <div class="card">
          <h3>Live Now / Today <span class="tag">${live.length ? "updated" : "none"}</span></h3>
          ${live.length
            ? renderRows(live, g=>`<div class="score">${escapeHtml(g.hs ?? "‚Äî")} : ${escapeHtml(g.as ?? "‚Äî")}</div>`)
            : `<div class="small">No live/today game found.</div>`}
        </div>

        <div class="card">
          <h3>Most Recent Game</h3>
          ${latest
            ? renderRows([latest], g=>`<div class="score">${escapeHtml(g.hs ?? "‚Äî")} : ${escapeHtml(g.as ?? "‚Äî")}</div>`)
            : `<div class="small">No completed game found.</div>`}
        </div>
      </div>

      <div class="card">
        <h3>Next Game <span class="tag">${next?.date ? "in " + escapeHtml(countdownTo(next.date)) : ""}</span></h3>
        ${next ? renderRows([next]) : `<div class="small">No upcoming game found.</div>`}
      </div>
    `;
  }

  function renderLive(){
    const meta = bundle?.meta || {};
    const live = getLiveGames(bundle?.scoreboard || {}, meta.teamId);
    view.innerHTML = `
      <div class="card">
        <h3>Live Now / Today</h3>
        ${live.length
          ? renderRows(live, g=>`<div class="score">${escapeHtml(g.hs ?? "‚Äî")} : ${escapeHtml(g.as ?? "‚Äî")}</div>`)
          : `<div class="small">No live/today game found.</div>`}
      </div>
    `;
  }

  function renderSchedule(){
    const { latest, next, all } = getLatestAndNext(bundle?.schedule || {});
    const upcoming = all.filter(e=>!e.completed).slice(0,20);
    const completed = all.filter(e=>e.completed).slice(-20).reverse();

    view.innerHTML = `
      <div class="grid">
        <div class="card">
          <h3>Next Game <span class="tag">${next?.date ? "in " + escapeHtml(countdownTo(next.date)) : ""}</span></h3>
          ${next ? renderRows([next]) : `<div class="small">No upcoming game found.</div>`}
        </div>

        <div class="card">
          <h3>Latest Completed</h3>
          ${latest ? renderRows([latest], g=>`<div class="score">${escapeHtml(g.hs ?? "‚Äî")} : ${escapeHtml(g.as ?? "‚Äî")}</div>`) : `<div class="small">No completed game found.</div>`}
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Upcoming (next 20)</h3>
          ${upcoming.length ? renderRows(upcoming) : `<div class="small">No upcoming games available.</div>`}
        </div>

        <div class="card">
          <h3>Recent (last 20)</h3>
          ${completed.length ? renderRows(completed, g=>`<div class="score">${escapeHtml(g.hs ?? "‚Äî")} : ${escapeHtml(g.as ?? "‚Äî")}</div>`) : `<div class="small">No recent games available.</div>`}
        </div>
      </div>
    `;
  }

  function findTeamInStandings(standingsJson, teamId){
    const entries = standingsJson?.children?.[0]?.standings?.entries
      || standingsJson?.standings?.entries
      || standingsJson?.entries
      || [];
    const match = entries.find(e => String(e?.team?.id) === String(teamId));
    return { entries, match };
  }

  function renderStandings(){
    const meta = bundle?.meta || {};
    const standings = bundle?.standings || {};
    const { entries, match } = findTeamInStandings(standings, meta.teamId);

    const lines = (entries || []).slice(0,15).map(e=>{
      const name = e?.team?.displayName || "‚Äî";
      const summary = e?.stats?.find(s=>s.name==="overall")?.displayValue
        || e?.stats?.find(s=>s.name==="wins")?.displayValue
        || e?.stats?.find(s=>s.name==="points")?.displayValue
        || "";
      const rank = e?.stats?.find(s=>s.name==="rank")?.displayValue || "";
      return `
        <div class="row">
          <div class="left">
            <div class="a">${escapeHtml(rank ? ("#" + rank + " ") : "")}${escapeHtml(name)}</div>
            <div class="b">${escapeHtml(summary)}</div>
          </div>
          <div class="right">${String(e?.team?.id) === String(meta.teamId) ? `<span class="tag ok">Selected</span>` : ""}</div>
        </div>
      `;
    }).join("");

    view.innerHTML = `
      <div class="card">
        <h3>Standings</h3>
        ${entries?.length ? lines : `<div class="small">Standings unavailable for this league endpoint (see Debug for details).</div>`}
      </div>
      <div class="card">
        <h3>Your Team Snapshot</h3>
        ${match
          ? `<div class="small">Found your team in standings data.</div>`
          : `<div class="small warn">Could not locate this team in standings payload. This can happen for some leagues/endpoints.</div>`}
      </div>
    `;
  }

  function extractRoster(rosterJson){
    const groups = rosterJson?.athletes || rosterJson?.team?.athletes || [];
    const flat = [];
    if(Array.isArray(groups)){
      for(const g of groups){
        if(g?.items && Array.isArray(g.items)){
          for(const p of g.items) flat.push(p);
        }
      }
    }
    const players = flat.length ? flat : (Array.isArray(rosterJson?.athletes) ? rosterJson.athletes : []);
    return players || [];
  }

  function renderRoster(){
    const players = extractRoster(bundle?.roster || {});
    if(!players.length){
      view.innerHTML = `<div class="card"><h3>Roster</h3><div class="small">Roster unavailable for this team/league endpoint.</div></div>`;
      return;
    }

    view.innerHTML = `
      <div class="card">
        <h3>Roster (top 70)</h3>
        ${players.slice(0,70).map(p=>{
          const n = p?.fullName || p?.displayName || "‚Äî";
          const pos = p?.position?.abbreviation || p?.position?.name || "‚Äî";
          const jersey = p?.jersey ? `#${p.jersey}` : "";
          const exp = p?.experience?.years != null ? (p.experience.years + " yrs") : "";
          return `
            <div class="row">
              <div class="left">
                <div class="a">${escapeHtml(n)} <span class="tag">${escapeHtml(jersey || "‚Äî")}</span></div>
                <div class="b">${escapeHtml(pos)}</div>
              </div>
              <div class="right">${escapeHtml(exp)}</div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  function extractInjuries(injuriesJson){
    // injuries endpoint shapes vary; keep it defensive
    const items =
      injuriesJson?.injuries ||
      injuriesJson?.athletes ||
      injuriesJson?.items ||
      injuriesJson?.entries ||
      [];
    return Array.isArray(items) ? items : [];
  }

  function renderInjuries(){
    const injuries = extractInjuries(bundle?.injuries || {});
    if(!injuries.length){
      view.innerHTML = `<div class="card"><h3>Injuries</h3><div class="small">No injury data available from this endpoint (or none reported).</div></div>`;
      return;
    }

    view.innerHTML = `
      <div class="card">
        <h3>Injuries</h3>
        ${injuries.slice(0,50).map(it=>{
          const athlete = it?.athlete || it?.player || it;
          const name = athlete?.displayName || athlete?.fullName || it?.displayName || "‚Äî";
          const status = it?.status?.description || it?.status || it?.injuryStatus || "‚Äî";
          const detail = it?.details?.[0]?.type || it?.injury?.type || it?.description || "";
          const date = it?.date || it?.startDate || "";
          return `
            <div class="row">
              <div class="left">
                <div class="a">${escapeHtml(name)}</div>
                <div class="b">${escapeHtml(status)}${detail ? " ‚Ä¢ " + escapeHtml(detail) : ""}${date ? " ‚Ä¢ " + escapeHtml(fmtDate(date)) : ""}</div>
              </div>
              <div class="right"></div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  function renderNews(){
    const news = bundle?.news || {};
    const articles = news?.articles || news?.headlines || [];
    if(!articles.length){
      view.innerHTML = `<div class="card"><h3>News</h3><div class="small">No news found.</div></div>`;
      return;
    }

    view.innerHTML = `
      <div class="card">
        <h3>Top News</h3>
        ${articles.slice(0,15).map(a=>{
          const title = a?.headline || a?.title || "‚Äî";
          const link = a?.links?.web?.href || a?.link || "";
          const when = a?.published || a?.lastModified || "";
          return `
            <div class="row">
              <div class="left">
                <div class="a">${escapeHtml(title)}</div>
                <div class="b">${when ? escapeHtml(fmtDate(when)) : ""}</div>
              </div>
              <div class="right">${link ? `<a href="${escapeHtml(link)}" target="_blank" rel="noopener">Open</a>` : ""}</div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  function renderSettings(){
    const isFav = selected && favs.has(selected.key);
    view.innerHTML = `
      <div class="card">
        <h3>Settings</h3>
        <div class="small">Favorites are stored on this device only.</div>
        <div class="btnRow" style="margin-top:10px;">
          <button class="miniBtn" id="favToggle">${isFav ? "‚òÖ Unfavorite" : "‚òÜ Favorite"}</button>
          <button class="miniBtn" id="clearFavs">Clear favorites</button>
          <button class="miniBtn" id="refreshNow">Refresh data</button>
        </div>
      </div>
      <div class="card">
        <h3>About</h3>
        <div class="small">
          Data source: ESPN endpoints via your Worker. Some fields (especially injuries/standings) vary by league and may be empty sometimes.
        </div>
      </div>
    `;

    $("favToggle").onclick = ()=>{
      if(!selected) return;
      toggleFavorite(selected.key);
      renderSettings();
      renderTeamMenu();
    };
    $("clearFavs").onclick = ()=>{
      favs = new Set();
      saveFavs(favs);
      renderTeamMenu();
      renderSettings();
    };
    $("refreshNow").onclick = ()=>{
      if(selected) selectTeam(selected, true);
    };
  }

  function renderTab(tab){
    if(!bundle) return;
    if(tab==="overview") return renderOverview();
    if(tab==="live") return renderLive();
    if(tab==="schedule") return renderSchedule();
    if(tab==="standings") return renderStandings();
    if(tab==="roster") return renderRoster();
    if(tab==="injuries") return renderInjuries();
    if(tab==="news") return renderNews();
    if(tab==="settings") return renderSettings();
    renderOverview();
  }

  async function selectTeam(team, force=false){
    selected = team;
    bundle = null;
    setLastTeamKey(team.key);
    renderTeamMenu();

    tabs.style.display = "flex";
    setActiveTab("overview");

    setStatus("Loading‚Ä¶", "idle");
    setHero({ fallbackName: team.name });

    view.innerHTML = `
      <div class="card">
        <h3>Loading</h3>
        <div class="small">Fetching live data‚Ä¶</div>
      </div>
    `;

    try{
      const data = await fetchBundle(team);
      bundle = data;

      setHero({
        teamName: data?.meta?.teamName || team.name,
        logo: data?.meta?.logo || "",
        venue: data?.meta?.venue || "",
        recordSummary: data?.meta?.recordSummary || ""
      });

      setStatus("Loaded", "ok");
      renderOverview();
    } catch (e){
      setStatus("Error", "bad");
      view.innerHTML = `
        <div class="card">
          <h3>Error</h3>
          <div class="small warn">${escapeHtml(String(e))}</div>
          <div class="small" style="margin-top:8px;">Open Debug below to see the exact Worker response.</div>
        </div>
      `;
    }
  }

  // Init
  renderTeamMenu();
  setStatus("Ready", "idle");

  // Restore last team (if any)
  const last = getLastTeamKey();
  const lastTeam = TEAMS.find(t=>t.key===last);
  if(lastTeam){
    selectTeam(lastTeam);
  }

  // PWA SW register
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js");
    });
  }
</script>
</body>
</html>
